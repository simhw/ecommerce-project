# ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ëž¨

## ì£¼ë¬¸í•˜ê¸°

### 1) ë¹„ê´€ì  ë½(Pessimistic Lock)

```mermaid
sequenceDiagram
    autonumber
    participant CLIENT
    participant ORDER_SERVICE
    participant EVENT_HANDLER
    participant PRODUCT_SERVICE
    participant MYSQL
    CLIENT ->> + ORDER_SERVICE: ì£¼ë¬¸í•˜ê¸°(command)
    ORDER_SERVICE ->> MYSQL: ìƒí’ˆ ì¡°íšŒ
    MYSQL -->> ORDER_SERVICE: ìƒí’ˆ ë°˜í™˜
    ORDER_SERVICE ->> EVENT_HANDLER: ì£¼ë¬¸ ì´ë²¤íŠ¸ ë°œí–‰
    EVENT_HANDLER ->>  + PRODUCT_SERVICE: ì£¼ë¬¸ ì´ë²¤íŠ¸ ìˆ˜ì‹  ë° ì²˜ë¦¬
    PRODUCT_SERVICE ->> MYSQL: ìƒí’ˆ ìž¬ê³  ì¡°íšŒ(+ pessimistic lock)
    MYSQL -->> PRODUCT_SERVICE: ìƒí’ˆ ìž¬ê³  ë°˜í™˜

    alt ìž¬ê³  ë¶€ì¡±
        PRODUCT_SERVICE ->> ORDER_SERVICE: ìž¬ê³  ë¶€ì¡± ì˜ˆì™¸ ë°œìƒ ðŸ”¥
        ORDER_SERVICE -->> CLIENT: ì‹¤íŒ¨ ì‘ë‹µ
    else ìž¬ê³  ì¶©ë¶„
        PRODUCT_SERVICE ->> - MYSQL: ìž¬ê³  ì°¨ê° í›„ ìˆ˜ì •
        ORDER_SERVICE ->> MYSQL: ì£¼ë¬¸ ì €ìž¥
        ORDER_SERVICE -->> - CLIENT: ì„±ê³µ ì‘ë‹µ
    end

```

### 2) ë¶„ì‚° ë½(Distributed Lock)

```mermaid
sequenceDiagram
    autonumber
    participant CLIENT
    participant ORDER_SERVICE
    participant EVENT_HANDLER
    participant PRODUCT_SERVICE
    participant MYSQL
    participant REDIS
    CLIENT ->> + ORDER_SERVICE: ì£¼ë¬¸í•˜ê¸°(command)
    ORDER_SERVICE ->> MYSQL: ìƒí’ˆ ì¡°íšŒ
    MYSQL -->> ORDER_SERVICE: ìƒí’ˆ ë°˜í™˜
    ORDER_SERVICE ->> MYSQL: ì£¼ë¬¸ ì €ìž¥
    ORDER_SERVICE ->> EVENT_HANDLER: ì£¼ë¬¸ ì´ë²¤íŠ¸ ë°œí–‰
    ORDER_SERVICE -->> - CLIENT: ì„±ê³µ ì‘ë‹µ(í›„ì²˜ë¦¬ ë¹„ë™ê¸°)
    EVENT_HANDLER ->> + PRODUCT_SERVICE: ì£¼ë¬¸ ì´ë²¤íŠ¸ ìˆ˜ì‹  ë° ì²˜ë¦¬
    PRODUCT_SERVICE ->> REDIS: multi lock íšë“
    PRODUCT_SERVICE ->> MYSQL: ìž¬ê³  ì¡°íšŒ
    MYSQL -->> PRODUCT_SERVICE: ìž¬ê³  ë°˜í™˜

    alt ìž¬ê³  ë¶€ì¡±
        PRODUCT_SERVICE ->> EVENT_HANDLER: ìž¬ê³  ë¶€ì¡± ì˜ˆì™¸ ë°œìƒ ðŸ”¥
        EVENT_HANDLER ->> ORDER_SERVICE: ì£¼ë¬¸ ìƒíƒœ ë³€ê²½
        ORDER_SERVICE ->> MYSQL: ì£¼ë¬¸ ìƒíƒœ('ì™„ë£Œ' â†’ 'ì‹¤íŒ¨') ìˆ˜ì •
    else ìž¬ê³  ì¶©ë¶„
        PRODUCT_SERVICE ->> MYSQL: ìž¬ê³  ì°¨ê° í›„ ìˆ˜ì •
    end
    PRODUCT_SERVICE -->> - REDIS: multi lock ë°˜í™˜


```

